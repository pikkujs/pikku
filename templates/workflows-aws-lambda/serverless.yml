# "org" ensures this Service is used with the correct Serverless Framework Access Key.
org: pikku
# "app" enables Serverless Framework Dashboard features and sharing them with other Services.
app: workflows-lambda

service: pikku-workflows-lambda

frameworkVersion: '4'

plugins:
  - serverless-offline-sqs
  - serverless-dynamodb
  - serverless-offline

provider:
  name: aws
  runtime: nodejs20.x
  stage: ${opt:stage, 'dev'}
  region: ${opt:region, 'us-east-1'}
  memorySize: 512
  timeout: 30

  environment:
    AWS_REGION: ${self:provider.region}
    RUNS_TABLE_NAME: ${self:custom.runsTableName}
    STEPS_TABLE_NAME: ${self:custom.stepsTableName}
    HISTORY_TABLE_NAME: ${self:custom.historyTableName}
    QUEUE_URL_PREFIX: ${env:QUEUE_URL_PREFIX, 'http://localhost:4566/000000000000/'}
    AWS_ACCOUNT_ID: ${env:AWS_ACCOUNT_ID, '000000000000'}

  iam:
    role:
      statements:
        # DynamoDB permissions
        - Effect: Allow
          Action:
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:Query
            - dynamodb:Scan
          Resource:
            - !GetAtt WorkflowRunsTable.Arn
            - !GetAtt WorkflowStepsTable.Arn
            - !GetAtt WorkflowStepHistoryTable.Arn
            - !Join ['', [!GetAtt WorkflowStepsTable.Arn, '/index/*']]

        # SQS permissions
        - Effect: Allow
          Action:
            - sqs:SendMessage
            - sqs:ReceiveMessage
            - sqs:DeleteMessage
            - sqs:GetQueueAttributes
          Resource:
            - !GetAtt WorkflowQueue.Arn

custom:
  runsTableName: ${self:service}-${self:provider.stage}-workflow-runs
  stepsTableName: ${self:service}-${self:provider.stage}-workflow-steps
  historyTableName: ${self:service}-${self:provider.stage}-workflow-step-history
  queueName: ${self:service}-${self:provider.stage}-workflow-queue
  serverless-dynamodb:
    start:
      port: 8000
      docker: false
      migrate: true

functions:
  http:
    handler: dist/handler.httpHandler
    events:
      - http:
          path: /{proxy+}
          method: any

  queueWorker:
    handler: dist/handler.queueHandler
    events:
      - sqs:
          arn: !GetAtt WorkflowQueue.Arn
          batchSize: 1

resources:
  Resources:
    # DynamoDB Tables
    WorkflowRunsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.runsTableName}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES

    WorkflowStepsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.stepsTableName}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: runStepKey
            AttributeType: S
          - AttributeName: runId
            AttributeType: S
        KeySchema:
          - AttributeName: runStepKey
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: runId-index
            KeySchema:
              - AttributeName: runId
                KeyType: HASH
            Projection:
              ProjectionType: ALL

    WorkflowStepHistoryTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.historyTableName}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: stepId
            AttributeType: S
          - AttributeName: attemptCount
            AttributeType: N
        KeySchema:
          - AttributeName: stepId
            KeyType: HASH
          - AttributeName: attemptCount
            KeyType: RANGE

    # SQS Queue
    WorkflowQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:custom.queueName}
        VisibilityTimeout: 180
        MessageRetentionPeriod: 1209600 # 14 days
        ReceiveMessageWaitTimeSeconds: 20 # Long polling

  Outputs:
    HttpApiUrl:
      Description: HTTP API endpoint URL
      Value: !Sub https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com

    WorkflowQueueUrl:
      Description: Workflow SQS Queue URL
      Value: !Ref WorkflowQueue

    WorkflowQueueArn:
      Description: Workflow SQS Queue ARN
      Value: !GetAtt WorkflowQueue.Arn

    RunsTableName:
      Description: DynamoDB Workflow Runs Table Name
      Value: !Ref WorkflowRunsTable

    StepsTableName:
      Description: DynamoDB Workflow Steps Table Name
      Value: !Ref WorkflowStepsTable

    HistoryTableName:
      Description: DynamoDB Workflow Step History Table Name
      Value: !Ref WorkflowStepHistoryTable
